#!/bin/sh

config="$(ppq_parse package < package.ppq)"
name="$(echo "$config" | grep '^set=#package#name=' | cut -d'=' -f3)"
version="$(echo "$config" | grep '^set=#package#version=' | cut -d'=' -f3)"
lib="$(echo "$config" | grep '^set=#package#lib=' | cut -d'=' -f3)"
bin="$(echo "$config" | grep '^set=#package#bin=' | cut -d'=' -f3)"

echo "cmake_minimum_required(VERSION 3.1)"
echo ""
echo "project($name VERSION $version LANGUAGES CXX)"
echo ""
echo "add_library($lib)"
echo "target_include_directories($lib PUBLIC"
echo "    \$<BUILD_INTERFACE:\${CMAKE_CURRENT_SOURCE_DIR}/include>"
echo "    \$<INSTALL_INTERFACE:include>)"
echo "target_sources($lib PRIVATE"
find src/"$name" -type f -name '*.cpp' -exec echo "    {}" ';'
echo "    )"
echo ""
echo "add_executable(${name}-bin src/main.cpp)"
echo "set_target_properties(${name}-bin"
echo "    PROPERTIES OUTPUT_NAME $bin)"
echo "target_link_libraries(${name}-bin"
echo "    $lib)"
echo ""
echo "install(TARGETS $lib ${name}-bin"
echo "    EXPORT ${name}-config"
echo "    ARCHIVE DESTINATION lib"
echo "    LIBRARY DESTINATION lib"
echo "    RUNTIME DESTINATION bin)"
echo ""
echo "install(EXPORT ${name}-config"
echo "    NAMESPACE ${name}"
echo "    DESTINATION lib/cmake/$name)"
echo ""
echo "include(CMakePackageConfigHelpers)"
echo ""
echo "write_basic_package_version_file("
echo "    \${CMAKE_CURRENT_BINARY_DIR}/${name}-config-version.cmake"
echo "    COMPATIBILITY SameMajorVersion)"
echo ""
echo "install(FILES \${CMAKE_CURRENT_BINARY_DIR}/${name}-config-version.cmake"
echo "    DESTINATION lib/cmake/$name)"
echo "install(DIRECTORY \${CMAKE_CURRENT_SOURCE_DIR}/include/"
echo "    DESTINATION include)"
echo ""
echo "if(CMAKE_PROJECT_NAME STREQUAL PROJECT_NAME)"
echo "    include(CTest)"
echo "    if(BUILD_TESTING)"
echo "        add_subdirectory(test)"
echo "    endif()"
echo "endif()"
